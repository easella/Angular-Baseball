var assert = require("assert");
var colors = require('colors');

import { Baseball } from 'baseball/baseball';
import { Animator } from 'baseball/Services/Animator';
import { Iterator } from 'baseball/Services/Iterator';

var seasons = 10;

describe('Game', function() {

    var Game = Baseball.Game;
    var Player = Baseball.Player;
    var Team = Baseball.Team;

    var log = function() {
        console.log.apply(console, arguments);
    };

    var format = function(n, digits) {
        n = '' + Math.floor(n*1000)/1000;
        while (n.indexOf('.') > -1 && n.length < 5) n += '0';
        while (n.indexOf('.') === -1 && n.length < 4) n = ' ' + n;
        return n;
    };

    Game.prototype.console = true;
    Game.prototype.humanControl = 'none';
    Game.prototype.quickMode = true;
    Animator.console = true;

    var game = new Game();
    game.gamesIntoSeason = 144;
    var player, p;
    player = new Player(game.teams.home, false);
    var asPitcher = Math.random() > 0.80;
    p = player;
    game.teams.home.lineup = [p,p,p,p,p,p,p,p,p];

    //var offense = {
    //    eye: 99,
    //    power: 98,
    //    speed: 95
    //};
    var offense = player.skill.offense;
    player.skill.offense = offense;
    player.resetStats(144);

    var vary = function(player) {
        player.skill.offense.eye += Math.floor(Math.random()*8 - Math.random()*8);
        player.skill.offense.speed += Math.floor(Math.random()*8 - Math.random()*8);
        player.skill.offense.power += Math.floor(Math.random()*8 - Math.random()*8);
    };

    var getStats = player => {
        return {
            pa: format(player.stats.batting.pa),
            ba: format(player.stats.batting.getBA()),
            h: format(player.stats.batting.h),
            '2b': format(player.stats.batting['2b']),
            '3b': format(player.stats.batting['3b']),
            hr: format(player.stats.batting.hr),
            bb: format(player.stats.batting.bb),
            r: format(player.stats.batting.r),
            so: format(player.stats.batting.so),
            sac: format(player.stats.batting.sac),
            rbi: format(player.stats.batting.rbi),
            obp: format(player.stats.batting.getOBP()),
            slg: format(player.stats.batting.getSLG()),
            ops: format(player.stats.batting.getOBP() + player.stats.batting.getSLG()),

            W: format(player.stats.pitching.W),
            L: format(player.stats.pitching.L),
            ERA: format(player.stats.pitching.getERA()),
            IP: (player.stats.pitching.IP.join('.')),
            K: format(player.stats.pitching.K),
            H: format(player.stats.pitching.H),
            BB: format(player.stats.pitching.BB),
            HR: format(player.stats.pitching.HR),
            K9: format(player.stats.pitching.getK9()),
            WHIP: format(player.stats.pitching.getWHIP())
        }
    };
    var career = {};
    var logPlayer = function(yr) {
        career[yr] = getStats(player);
    };

    var year = new Date().getFullYear() - seasons;

    logPlayer((++year, 'Rkie'));
    log(asPitcher ? player.skill.pitching : player.skill.offense);
    log('------');

    var runSeason = function(n) {
        var x = 15000;
        game.gamesIntoSeason = 0;
        p = player;
        if (asPitcher) {
            game.teams.home.positions.pitcher = p;
            game.teams.away.positions.pitcher = p;
            p.resetStats();
        } else {
            player = p = new Player(game.teams.home, false);
            player.skill.offense = offense;
            game.teams.home.lineup = [p,p,p,p,p,p,p,p,p];
            vary(player);
        }

        var games = 0;
        do {
            game.simulateInput(function(callback) {
                typeof callback == 'function' && callback();
            });
            if (game.stage == 'end') {
                game.teams.away = new Team(game);
                if (asPitcher) {
                    game.teams.home = new Team(game);
                    game.teams.home.positions.pitcher = p;
                }
                game.inning = 1;
                game.half = 'top';
                game.stage = 'pitch';
                game.resetTally();
                games++;
            }
            if (!asPitcher && game.batter !== player) {
                game.umpire.changeSides();
            }
            if (!asPitcher && player.stats.batting.pa % 10 == 0) {
                game.teams.away.positions.pitcher = new Player(game.teams.away, true);
            }
        } while (games < 144/9 && x--);
        logPlayer(++year);
    };

    var times = [Date.now()];
    runSeason(2);
    times.push(Date.now());
    runSeason(3);
    times.push(Date.now());
    runSeason(4);
    times.push(Date.now());
    runSeason(5);
    times.push(Date.now());
    runSeason(6);
    times.push(Date.now());
    runSeason(7);
    times.push(Date.now());
    runSeason(8);
    times.push(Date.now());
    runSeason(9);
    times.push(Date.now());
    runSeason(10);
    times.push(Date.now());
    //runSeason(10);
    //runSeason(11);
    //runSeason(12);
    //runSeason(13);
    //runSeason(14);

    log(asPitcher ? player.skill.pitching : player.skill.offense);

    (function logCareer() {
        var statLines = {};
        for (var year in career) {
            if (!asPitcher || year != 'Rkie') {
                for (var stat in career[year]) {
                    if (typeof statLines[stat] === 'undefined') {
                        statLines[stat] = [];
                    }
                    statLines[stat].push(career[year][stat]);
                }
            }
        }

        var logYear = function(stats) {
            let highest = stat => {
                return stats[stat] == Math.max.apply(this, statLines[stat]) ? stats[stat].toString().yellow : stats[stat]
            };
            let filter = stat => {
                var s = highest(stat);
                return s == Math.min.apply(this, statLines[stat]) ? s.toString().blue : s;
            };
            if (asPitcher) {
                log(
                    year + '',
                    ' | W ' + filter('W'),
                    ' | L ' + filter('L'),
                    ' | ERA ' + filter('ERA'),
                    ' | IP ' + filter('IP'),
                    ' | K ' + filter('K'),
                    ' | H ' + filter('H'),
                    ' | BB ' + filter('BB'),
                    ' | WHIP ' + filter('WHIP'),
                    ' | K9 ' + filter('K9'),
                    ' | HR ' + filter('HR')
                );
            } else {
                log(
                    year + '',
                    ' | PA ' + filter('pa'),
                    ' | AV ' + filter('ba'),
                    ' | H '  + filter('h'),
                    ' | 2B ' + filter('2b'),
                    ' | 3B ' + filter('3b'),
                    ' | HR ' + filter('hr'),
                    ' | BB ' + filter('bb'),
                    ' | R ' + filter('r'),
                    ' | K  ' + filter('so'),
                    ' | SAC ' + filter('sac'),
                    ' | RBI ' + filter('rbi'),
                    ' | OBP ' + filter('obp'),
                    ' | SLG ' + filter('slg'),
                    ' | OPS ' + filter('ops')
                );
            }
        };
        logYear(career.Rkie);
        for (year in career) {
            if (year != 'Rkie') {
                var stats = career[year];
                logYear(stats);
            }
        }
        var sum = (a, b) => format(parseFloat(a) + parseFloat(b));
        var totals = {};
        Iterator.each(statLines, (k, v) => {
            totals[k] = v.reduce(sum);
        });
        year = 'All ';
        totals.ba = format(totals.ba/seasons);
        totals.obp = format(totals.obp/seasons);
        totals.slg = format(totals.slg/seasons);
        totals.ops = format(totals.ops/seasons);
        totals.ERA = format(totals.ERA/seasons);
        totals.WHIP = format(totals.WHIP/seasons);
        totals.K9 = format(totals.K9/seasons);
        log('------');
        logYear(totals);
    })();

    //game.debugOut();
    it('running times', function() {
        times = times.map(function(x, k) {
            return times[k] - (times[k-1] || 0);
        });
        times.shift();
        console.log(times.join('ms, ')+'ms');
        var avg = times.reduce((a, b) => a + b)/(seasons - 1) | 0;
        console.log('average: ', avg, 'ms/year');
    });
    it('I\'ve seen a lot in my life. I think it\'s time to retire.', function () {
        assert(300 < player.stats.batting.ab || 100 < player.stats.pitching.IP[0]);
    });
    it('    - ' + player.name, function() {
        assert(true);
    });
});